const s="vaults.db",l="vaults",r="vault_names";let i=null;async function o(){return i||(i=(async()=>{var e;if((e=window.electronAPI)!=null&&e.sqlite){const a=await window.electronAPI.getAppPath("userData"),t=await window.electronAPI.pathJoin(a,s);console.log(`Electron DB Service: Opening database at: ${t}`);const{success:n}=await window.electronAPI.sqlite.open(t);if(!n)throw new Error("Failed to open Electron database.")}else console.warn("Electron SQLite API not available. Using fallback behavior.")})()),i}const c={async getVaultNames(){var e;if(await o(),!((e=window.electronAPI)!=null&&e.sqlite))return[];try{const{rows:a}=await window.electronAPI.sqlite.all(`SELECT name FROM ${r}`);return a.map(t=>t.name)}catch(a){throw new Error(`Failed to get vault names from Electron DB: ${a.message}`)}},async saveVaultNames(e){var a;if(await o(),!!((a=window.electronAPI)!=null&&a.sqlite))try{await window.electronAPI.sqlite.run(`DELETE FROM ${r}`);for(const t of e)await window.electronAPI.sqlite.run(`INSERT OR IGNORE INTO ${r} (name) VALUES (?)`,[t])}catch(t){throw new Error(`Failed to save vault names to Electron DB: ${t.message}`)}},async getVault(e){var a;if(await o(),!((a=window.electronAPI)!=null&&a.sqlite))return null;try{const{row:t}=await window.electronAPI.sqlite.get(`SELECT data FROM ${l} WHERE name = ?`,[e]);return t?JSON.parse(t.data):null}catch(t){throw new Error(`Failed to get vault '${e}' from Electron DB: ${t.message}`)}},async saveVault(e,a){var t;if(await o(),!((t=window.electronAPI)!=null&&t.sqlite)){console.warn("Cannot save vault: Electron SQLite API not available");return}try{await window.electronAPI.sqlite.run(`INSERT OR REPLACE INTO ${l} (name, data) VALUES (?, ?)`,[e,JSON.stringify(a)]);const n=await this.getVaultNames();n.includes(e)||await this.saveVaultNames([...n,e])}catch(n){throw new Error(`Failed to save vault '${e}' to Electron DB: ${n.message}`)}},async deleteVault(e){var a;if(await o(),!((a=window.electronAPI)!=null&&a.sqlite)){console.warn("Cannot delete vault: Electron SQLite API not available");return}try{await window.electronAPI.sqlite.run(`DELETE FROM ${l} WHERE name = ?`,[e]);const t=await this.getVaultNames();await this.saveVaultNames(t.filter(n=>n!==e))}catch(t){throw new Error(`Failed to delete vault '${e}' from Electron DB: ${t.message}`)}}};export{c as dbService};
